# Wazumation

**Production-grade security automation tool for Wazuh configuration management**

Wazumation is a local-only Python application that automates Wazuh manager + agent configuration safely.

## Threat Model Summary

Wazumation is designed with security-first principles:

1. **Local-only**: No cloud control plane, no remote command execution, no telemetry, no outbound calls by default.
2. **Explicit privilege**: Operations that require root must prompt for sudo and log the elevation event.
3. **Immutable audit**: Every action is recorded in an append-only audit log that cannot be deleted from the GUI. Each log entry includes a hash of (previous_entry_hash + current_entry_payload) for tamper-evidence.
4. **Two-phase apply**: Dry run always available, diff preview before apply, explicit user approval required.
5. **Config validation gates**: Timestamped backups before changes, validation before service restart, automatic rollback on validation failure.
6. **No mock data**: All state shown in GUI reflects real filesystem/API reads.

## Installation

### Prerequisites

- Python 3.9 or higher
- Wazuh manager installed (for full functionality)
- lxml for XML parsing (required)
- PySide6 (Qt) for GUI (optional)

### Install from Source

```bash
# Clone or extract the repository
cd wazumation

# Install in development mode
pip install -e .

# Or install with dev dependencies
pip install -e ".[dev]"

# Optional: install GUI dependencies
pip install -e ".[gui]"
```

### Install Dependencies Only

```bash
pip install lxml>=4.9.0
# Optional GUI:
pip install PySide6>=6.6.0
```

## Usage

### GUI Mode

Launch the graphical interface:

```bash
wazumation-gui
# or
python -m wazumation.ui.main
```

The GUI provides:
- **Dashboard**: Environment detection, version info, service status
- **Modules**: Configure each Wazuh plugin/section
- **Plan & Diff**: Preview changes before applying
- **Audit Log**: View immutable audit trail (export allowed, delete NOT allowed)
- **Policy**: Configure retention, approval workflow, module allowlist/denylist

### CLI Mode

```bash
# Read current configuration
wazumation read syscheck --config /var/ossec/etc/ossec.conf

# Create a change plan
wazumation plan syscheck --config /var/ossec/etc/ossec.conf \
  --desired desired_state.json --output plan.json

# View diff for a plan
wazumation diff plan.json

# Apply a plan (dry-run)
wazumation apply plan.json --approve --dry-run --config /var/ossec/etc/ossec.conf

# Apply a plan (real)
wazumation apply plan.json --approve --config /var/ossec/etc/ossec.conf

# View audit log
wazumation audit --module syscheck --limit 50

# Verify audit chain integrity
wazumation verify
```

#### Example: Desired State JSON Format

For `syscheck` plugin:
```json
{
  "disabled": "yes",
  "frequency": "86400",
  "scan_on_start": "yes"
}
```

For `localfile` plugin:
```json
{
  "log_format": "syslog",
  "location": "/var/log/auth.log"
}
```

See `examples/` directory for more examples.

## How Audit Immutability Works

The audit log uses a cryptographic hash chain:

1. Each entry includes:
   - `entry_id`: Unique identifier
   - `timestamp`: When the action occurred
   - `previous_hash`: Hash of the previous entry
   - `current_hash`: Hash of (previous_hash + current_entry_payload)
   - `user`, `action`, `module`, `result`, `details`

2. The hash chain ensures:
   - Any modification to a past entry breaks the chain
   - Verification detects tampering immediately
   - Entries cannot be deleted without detection

3. Storage:
   - Primary: SQLite database (`~/.wazumation/audit.db`)
   - Export: JSONL format for external analysis
   - Retention: Configurable (default 30 days)

4. Verification:
   - Use `wazumation verify` CLI command
   - Or click "Verify Chain Integrity" in GUI Audit Log tab

## Supported Wazuh Configuration

### ossec.conf coverage (authoritative)

Wazumation implements **every** ossec.conf section listed in the official Wazuh documentation index:
- Source: `Local configuration (ossec.conf) - Reference (index)` (`https://documentation.wazuh.com/current/user-manual/reference/ossec-conf/index.html`)
- Committed authoritative list: `data/wazuh_sections.json` (generated by `tools/sync_wazuh_sections.py`)
- Committed per-section option schemas: `data/wazuh_section_schemas.json` (generated by `tools/scrape_wazuh_section_schema.py`)

You can print the current supported set at any time (this output is generated from the official docs index and must match it exactly):

```bash
python -m wazumation.cli.main list-plugins
```

### Plugin System

Wazumation uses a doc-driven plugin architecture. Each section plugin supports:
- Reading current configuration state
- Validating desired state
- Generating change plans
- Deterministic plan/diff via normalized states

Note on filenames: Some section names contain hyphens (valid XML tags) which are not valid Python module names. For those, wrapper modules are generated under `wazumation/wazuh/plugins/generated_sections/` using underscore filenames (e.g. `active-response` → `active_response.py`), while the plugin’s `section_name` remains the exact XML tag.

### Out of scope

Wazumation does **not** manage `internal_options.conf` or other non-ossec.conf internal tuning files unless explicitly requested.

## How to Add New Plugins

Plugins are modular and easy to extend:

1. Update the authoritative docs list / schemas (if Wazuh docs changed):

```bash
python tools/sync_wazuh_sections.py
python tools/scrape_wazuh_section_schema.py
```

2. Regenerate wrapper modules (optional, for structure/traceability):

```bash
python tools/generate_all_plugins.py
```

3. The runtime engine is doc-driven (`wazumation/wazuh/plugins/doc_driven.py`). If a section’s doc structure changes, update the scraper/engine accordingly.
```python
from typing import Dict, Any, List, Tuple
from wazumation.wazuh.plugins.base_plugin import BaseWazuhPlugin

class MyPlugin(BaseWazuhPlugin):
    def __init__(self):
        super().__init__("myplugin", "my_section", ["manager", "agent"])
    
    def get_default_state(self) -> Dict[str, Any]:
        return {"children": {"setting": {"text": "value"}}}
    
    def validate(self, state: Dict[str, Any]) -> Tuple[bool, List[str]]:
        errors = []
        # Add validation logic
        return len(errors) == 0, errors
```

2. Register it in `wazumation/wazuh/plugins/__init__.py`:

```python
from wazumation.wazuh.plugins.my_plugin import MyPlugin

def register_all_plugins(registry):
    # ... existing registrations ...
    registry.register(MyPlugin())
```

3. The plugin automatically appears in the CLI and GUI.

## Supported Wazuh Versions

Wazumation is designed to work with:
- Wazuh 4.x (primary target)
- Wazuh 3.x (should work, may need testing)

The tool reads configuration directly from Wazuh's XML files and uses Wazuh's own validation tools (`wazuh-control testconfig`) when available.

## Project Structure

```
wazumation/
├── wazumation/
│   ├── core/           # Core engine: plans, diff, audit, backup, validation, applier
│   ├── wazuh/          # Wazuh-specific: plugins, XML parser/writer
│   │   └── plugins/    # Individual configuration plugins
│   ├── ui/             # PySide6 GUI components
│   └── cli/            # Command-line interface
├── tests/              # Unit tests
└── pyproject.toml      # Project configuration
```

## Safety Features

1. **Atomic writes**: All file writes use temp file → fsync → rename pattern
2. **Automatic backups**: Timestamped backups before every change
3. **Validation gates**: XML validation before and after changes
4. **Rollback on failure**: Automatic rollback if validation fails
5. **Read-only mode**: Default mode prevents accidental writes
6. **Explicit approval**: No changes without user approval
7. **Sudo logging**: All privilege escalations are logged

## Development

### Running Tests

```bash
python -m unittest discover -s tests -p "test_*.py"
```

### Code Style

```bash
black wazumation/
mypy wazumation/
```

## License

MIT License

## Contributing

Contributions welcome! Please ensure:
- All changes maintain security-first principles
- Tests are included for new features
- Audit logging is added for all operations
- Documentation is updated

## Disclaimer

Wazumation is a configuration management tool. Always:
- Test changes in a non-production environment first
- Review diffs carefully before applying
- Maintain backups of your Wazuh configuration
- Understand the impact of configuration changes on your security posture

